<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout | Feminine Flame</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/checkout.css') }}">
</head>
<body>

  <!-- HEADER -->
  <header>
    <div class="logo">
      <img src="{{ url_for('static', filename='Images/Logo b.png') }}" alt="Feminine Flame">
    </div>
    <nav>
      <ul>
        <li><a href="/">Home</a></li>
        <li><a href="/">Perfumes</a></li>
        <li><a href="/">eBooks</a></li>
        <li><a href="/">About</a></li>
        <li><a href="/">Contact</a></li>
        <li><a href="{{ url_for('cart') }}">My Cart</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <div class="checkout-container">
      <h1>Complete Your Order</h1>
      
      <form id="checkout-form" method="POST">
        <div class="form-group">
          <label for="name">Full Name</label>
          <input type="text" id="name" name="name" required>
        </div>

        <div class="form-group">
          <label for="country">Country</label>
          <select id="country" name="country" required>
            <option value="">Select Country</option>
            <option value="Kenya">Kenya</option>
            <option value="UK">United Kingdom</option>
          </select>
        </div>

        <div class="form-group">
          <label for="phone">Phone Number</label>
          <input type="tel" id="phone" name="phone" placeholder="e.g. +254712345678" required>
        </div>

        <div class="form-group">
          {% set ns = namespace(has_ebooks=false) %}
          {% for item in cart %}
            {% if item.category == 'ebook' %}
              {% set ns.has_ebooks = true %}
            {% endif %}
          {% endfor %}

          <label for="email">
            Email Address {% if ns.has_ebooks %}(Required for eBooks){% else %}(Optional){% endif %}
          </label>
          <input
            type="email"
            id="email"
            name="email"
            placeholder="you@example.com"
            {% if ns.has_ebooks %}required{% endif %}
          >
          {% if ns.has_ebooks %}
            <small style="display:block;margin-top:6px;color:#666;">
              We use your email to unlock your ebook download after payment.
            </small>
          {% endif %}
        </div>

        <div class="form-group">
          <label for="address">Delivery Address</label>
          <textarea id="address" name="address" rows="3" placeholder="Include street, city, postal code" required></textarea>
        </div>

        <!-- Payment Instructions -->
<div id="payment-instructions">
  <div id="uk-info" class="uk-info">
    <strong>üá¨üáß UK Customers:</strong><br>
    After placing your order, you'll be redirected to our <strong>secure Stripe payment page</strong> to complete your GBP (¬£) payment.
  </div>

  <div id="mpesa-info" class="mpesa-info">
    <strong>üá∞üá™ Kenyan Customers:</strong><br>
    Please send your payment via <strong>M-Pesa to: <span style="color: #c25e7d; font-weight: bold;">0715072834</span></strong>.<br>
    Include your name and order details in the message. We‚Äôll confirm once received!
  </div>
</div>

        <button type="submit" class="btn-checkout">Place Order</button>
      </form>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="site-footer">
    <div class="footer-container">
      <div class="footer-col">
        <img src="{{ url_for('static', filename='Images/Logo.jpg') }}" alt="Feminine Flame" class="footer-logo">
        <p class="footer-desc">
          Curating luxury perfumes and soulful stories for the modern woman who dares to leave a trail.
        </p>
      </div>
      <div class="footer-col">
        <h3>Shop</h3>
        <ul>
          <li><a href="/">Perfumes</a></li>
          <li><a href="/">eBooks</a></li>
          <li><a href="/">New Arrivals</a></li>
          <li><a href="/">Best Sellers</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <h3>Contact Us</h3>
        <ul class="contact-info">
          <li>üìß feminineflame19@gmail.com</li>
          <li>üì± +447 301 623 591</li>
          <li>üìç Nairobi, Kenya</li>
        </ul>
      </div>
      <div class="footer-col">
        <h3>Follow Us</h3>
        <div class="social-links">
          <a href="https://instagram.com/your_instagram" target="_blank" class="social-link" aria-label="Instagram">
            <i class="fab fa-instagram"></i>
          </a>
          <a href="https://facebook.com/your_facebook" target="_blank" class="social-link" aria-label="Facebook">
            <i class="fab fa-facebook-f"></i>
          </a>
          <a href="mailto:kipkenycollo@gmail.com" class="social-link" aria-label="Email">
            <i class="fas fa-envelope"></i>
          </a>
          <a href="https://wa.me/254742954960" target="_blank" class="social-link" aria-label="WhatsApp">
            <i class="fab fa-whatsapp"></i>
          </a>
        </div>
        <p class="social-desc">Stay inspired with our latest drops.</p>
      </div>
    </div>
    <div class="footer-bottom">
      <p>&copy; 2025 Feminine Flame. All rights reserved.</p>
    </div>
  </footer>

  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3/"></script>

  <script>
document.getElementById('checkout-form').addEventListener('submit', async function(e) {
  const country = document.getElementById('country').value;

  if (country === 'UK') {
    e.preventDefault(); // ‚Üê Critical: Prevent form submission

    const formData = new FormData(this);
    const data = {
      name: formData.get('name'),
      phone: formData.get('phone'),
      address: formData.get('address'),
      country: formData.get('country'),
      email: formData.get('email') || ''
    };

    try {
      // Create order + Stripe session in ONE call
      const response = await fetch('/create-checkout-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      const result = await response.json();
      
      if (!response.ok) throw new Error(result.error || 'Failed to create checkout');

      // Redirect to Stripe
      const stripe = Stripe('{{ stripe_pub_key }}');
      const { error } = await stripe.redirectToCheckout({ sessionId: result.id });
      if (error) alert('Stripe error: ' + error.message);
    } catch (err) {
      console.error(err);
      alert('Payment setup failed: ' + err.message);
    }
  }
  // Kenya: Allow normal form submission
});
</script>
</body>
</html>