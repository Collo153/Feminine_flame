<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Feminine Flame</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
</head>
<body>
    <div class="admin-container">
        {% if page == 'login' %}
        <div class="login-container">
            <h2>Admin Login</h2>
            <form method="POST">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="email" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" name="password" required>
                </div>
                <button type="submit" class="login-btn">Login</button>
            </form>
        </div>
        {% else %}
        <div class="admin-header">
            <h1>‚ú® Feminine Flame Admin Panel</h1>
            <a href="{{ url_for('admin', action='logout') }}">
                <button class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </a>
        </div>

        <div class="tabs">
            <button class="tab-btn {% if tab == 'dashboard' %}active{% endif %}" onclick="showTab('dashboard')">Dashboard</button>
            <button class="tab-btn {% if tab == 'products' %}active{% endif %}" onclick="showTab('products')">Products</button>
            <button class="tab-btn {% if tab == 'orders' %}active{% endif %}" onclick="showTab('orders')">Orders</button>
        </div>

        <!-- DASHBOARD TAB -->
        <div id="dashboard" class="tab-content {% if tab != 'dashboard' %}hidden{% endif %}">
            <h2>Welcome to Admin Dashboard</h2>
            <div style="margin-top: 30px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 10px; color: white;">
                        <h3 style="margin-bottom: 15px;">üìä Total Products</h3>
                        <p style="font-size: 48px; font-weight: bold; margin: 0;">{{ products|length if products else 0 }}</p>
                    </div>
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 30px; border-radius: 10px; color: white;">
                        <h3 style="margin-bottom: 15px;">üõçÔ∏è Total Orders</h3>
                        <p style="font-size: 48px; font-weight: bold; margin: 0;">{{ orders|length if orders else 0 }}</p>
                    </div>
                    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 30px; border-radius: 10px; color: white;">
                        <h3 style="margin-bottom: 15px;">üí∞ Revenue</h3>
                        <p style="font-size: 36px; font-weight: bold; margin: 0;">KES 0</p>
                        <small style="opacity: 0.8;">(Coming soon)</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- PRODUCTS TAB -->
        <div id="products" class="tab-content {% if tab != 'products' %}hidden{% endif %}">
            <h2>Manage Products</h2>

            <!-- Add/Edit Product Form -->
            <div class="add-product-form">
                <h3>{% if edit_product %}Edit Product{% else %}Add New Product{% endif %}</h3>
                <form method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="product_id" value="{% if edit_product %}{{ edit_product._id }}{% endif %}">
                    
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" name="name" value="{% if edit_product %}{{ edit_product.name }}{% endif %}" required>
                    </div>

                    <div class="form-group">
                        <label>Description</label>
                        <textarea name="description" required>{% if edit_product %}{{ edit_product.description }}{% endif %}</textarea>
                    </div>

                    <div class="form-group">
                        <label>Category</label>
                        <select name="category" id="categorySelect" required>
                            <option value="perfume" {% if edit_product and edit_product.category == 'perfume' %}selected{% endif %}>Perfume</option>
                            <option value="ebook" {% if edit_product and edit_product.category == 'ebook' %}selected{% endif %}>Ebook</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Price (KES)</label>
                        <input type="number" name="price" step="0.01" value="{% if edit_product %}{{ edit_product.price }}{% endif %}" required>
                    </div>

                    <div class="form-group" id="stockField" {% if edit_product and edit_product.category == 'ebook' %}style="display: none;"{% endif %}>
                        <label>Stock</label>
                        <input type="number" name="stock" value="{% if edit_product %}{{ edit_product.stock }}{% else %}10{% endif %}" required>
                    </div>

                    <div class="form-group">
                        <label>Product Image</label>
                        <input type="file" name="image" accept="image/*">
                        {% if edit_product and edit_product.image_url %}
                        <small>Current image: {{ edit_product.image_url }}</small>
                        {% endif %}
                    </div>

                    <!-- Ebook-specific fields -->
                    <div id="ebookFields" class="ebook-fields" style="display: {% if edit_product and edit_product.category == 'ebook' %}block{% else %}none{% endif %};">
                        <h4>Ebook Details</h4>

                        <div class="form-group">
                            <label>Preview Text (first 1000 characters shown to customers)</label>
                            <textarea name="preview_text" maxlength="1000">{% if edit_product %}{{ edit_product.preview_text }}{% endif %}</textarea>
                            <small style="color: #666;">This text will be displayed before purchase</small>
                        </div>

                        <div class="form-group">
                            <label>Author</label>
                            <input type="text" name="author" value="{% if edit_product %}{{ edit_product.author }}{% endif %}">
                        </div>

                        <div class="form-group">
                            <label>Ebook File (PDF, EPUB, MOBI)</label>
                            {% if edit_product and edit_product.file_path %}
                            <div class="alert alert-info">
                                <strong>Current file:</strong> {{ edit_product.file_path }}
                                <br>
                                <small>To replace, upload a new file below</small>
                            </div>
                            {% endif %}
                            <input type="file" id="ebookFile" accept=".pdf,.epub,.mobi" style="margin-bottom: 10px;">
                            <small style="color: #666;">Max file size: 50MB. File will be encrypted for security.</small>
                            
                            <div id="uploadProgress" class="upload-progress">
                                <div class="progress-bar">
                                    <div id="progressFill" class="progress-fill"></div>
                                </div>
                                <small id="uploadStatus" style="color: #666;"></small>
                            </div>

                            <input type="hidden" name="ebook_file_path" id="ebookFilePath" 
                                   value="{% if edit_product %}{{ edit_product.file_path }}{% endif %}">
                            <input type="hidden" name="ebook_file_type" id="ebookFileType" 
                                   value="{% if edit_product %}{{ edit_product.file_type }}{% endif %}">
                        </div>
                    </div>

                    <button type="submit" class="btn-submit">
                        <i class="fas fa-save"></i> {% if edit_product %}Update Product{% else %}Add Product{% endif %}
                    </button>
                </form>
            </div>

            <!-- Products List -->
            <div class="products-list">
                <h3>Existing Products</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Price</th>
                            <th>Stock</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in products %}
                        <tr>
                            <td>
                                {% if product.image_url %}
                                <img src="{{ url_for('static', filename='uploads/' + product.image_url) }}" 
                                     class="product-image" 
                                     alt="{{ product.name }}">
                                {% else %}
                                <span style="color: #999;">No Image</span>
                                {% endif %}
                            </td>
                            <td>{{ product.name }}</td>
                            <td>
                                {% if product.category == 'ebook' %}
                                <span style="background: #e8f4fd; color: #667eea; padding: 3px 10px; border-radius: 15px; font-size: 14px;">
                                    <i class="fas fa-book"></i> Ebook
                                </span>
                                {% else %}
                                <span style="background: #e8f5e9; color: #4caf50; padding: 3px 10px; border-radius: 15px; font-size: 14px;">
                                    <i class="fas fa-spray-can"></i> Perfume
                                </span>
                                {% endif %}
                            </td>
                            <td>KES {{ "%.2f"|format(product.price) }}</td>
                            <td>
                                {% if product.stock == -1 %}
                                <span style="color: #667eea;">Unlimited</span>
                                {% else %}
                                {{ product.stock }}
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('admin', tab='products', edit=product._id) }}">
                                    <button class="action-btn btn-edit">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                </a>
                                <a href="{{ url_for('admin', action='delete', type='product', id=product._id) }}" 
                                   onclick="return confirm('Are you sure you want to delete this product?')">
                                    <button class="action-btn btn-delete">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ORDERS TAB -->
        <div id="orders" class="tab-content {% if tab != 'orders' %}hidden{% endif %}">
            <h2>Manage Orders</h2>

            <div style="margin-bottom: 20px; text-align: right;">
                <form method="POST" style="display: inline;">
                    <button type="submit" name="clear_orders" class="action-btn btn-delete" 
                            onclick="return confirm('Clear all orders? This cannot be undone!')">
                        <i class="fas fa-trash-alt"></i> Clear All Orders
                    </button>
                </form>
            </div>

            <div class="orders-list">
                <h3>Recent Orders</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Email</th>
                            <th>Country</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        <tr>
                            <td>{{ order._id[:8] }}</td>
                            <td>{{ order.customer_name }}</td>
                            <td>{{ order.email }}</td>
                            <td>{{ order.country }}</td>
                            <td>KES {{ "%.2f"|format(order.total) }}</td>
                            <td>
                                {% if order.status == 'pending' %}
                                <span class="status-badge status-pending">Pending</span>
                                {% elif order.status == 'paid' %}
                                <span class="status-badge status-paid">Paid</span>
                                {% elif order.status == 'delivered' %}
                                <span class="status-badge status-delivered">Delivered</span>
                                {% else %}
                                <span class="status-badge" style="background: #95a5a6; color: white;">{{ order.status }}</span>
                                {% endif %}
                            </td>
                            <td>{{ order.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>
                                {% if order.status == 'pending' %}
                                <form method="POST" style="display: inline;">
                                    <input type="hidden" name="order_id" value="{{ order._id }}">
                                    <input type="hidden" name="new_status" value="paid">
                                    <button type="submit" class="action-btn btn-edit">
                                        <i class="fas fa-credit-card"></i> Mark Paid
                                    </button>
                                </form>
                                {% endif %}

                                {% if order.status == 'paid' %}
                                <form method="POST" style="display: inline;">
                                    <input type="hidden" name="order_id" value="{{ order._id }}">
                                    <input type="hidden" name="new_status" value="delivered">
                                    <button type="submit" class="action-btn btn-deliver">
                                        <i class="fas fa-truck"></i> Mark Delivered
                                    </button>
                                </form>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>

    <script>
        // Tab switching
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.remove('hidden');
            
            // Update URL
            window.history.pushState({}, '', `?tab=${tabName}`);
        }

        // Category change handler
        document.getElementById('categorySelect').addEventListener('change', function() {
            const ebookFields = document.getElementById('ebookFields');
            const stockField = document.getElementById('stockField');
            
            if (this.value === 'ebook') {
                ebookFields.style.display = 'block';
                stockField.style.display = 'none';
            } else {
                ebookFields.style.display = 'none';
                stockField.style.display = 'block';
            }
        });

        // Ebook file upload handler
        document.getElementById('ebookFile')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('ebook_file', file);

            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressFill');
            const statusText = document.getElementById('uploadStatus');

            progressDiv.style.display = 'block';
            statusText.textContent = 'Uploading...';
            progressBar.style.width = '10%';

            fetch('/admin/upload-ebook', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('ebookFilePath').value = data.file_path;
                    document.getElementById('ebookFileType').value = data.file_type;
                    progressBar.style.width = '100%';
                    statusText.textContent = `‚úì Upload complete! (${(data.file_size / 1024 / 1024).toFixed(2)} MB)`;
                    statusText.style.color = '#2ecc71';
                    
                    // Show success message
                    setTimeout(() => {
                        alert('Ebook uploaded successfully! Don\'t forget to save the product.');
                    }, 500);
                } else {
                    alert('Upload failed: ' + (data.error || 'Unknown error'));
                    progressBar.style.width = '0%';
                    statusText.textContent = '';
                    progressDiv.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Upload failed. Please try again.');
                progressDiv.style.display = 'none';
            });
        });
    </script>
</body>
</html>