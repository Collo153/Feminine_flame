<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard | Feminine Flame</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

  {% if page == 'login' %}
  <div class="login-container">
    <div class="login-card">
      <h2>Feminine Flame Admin</h2>
      <form method="POST">
        <input type="email" name="email" placeholder="Admin Email" required>
        <input type="password" name="password" placeholder="Password" required>
        <button type="submit">Login</button>
      </form>
    </div>
  </div>

  {% else %}
  <div class="admin-layout">
    <aside class="sidebar">
      <div class="logo">Feminine Flame</div>
      <nav>
        <a href="{{ url_for('admin', tab='dashboard') }}" class="{{ 'active' if tab == 'dashboard' }}"> 
          <i class="fas fa-tachometer-alt"></i> Dashboard
        </a>
        <a href="{{ url_for('admin', tab='products') }}" class="{{ 'active' if tab == 'products' }}"> 
          <i class="fas fa-box"></i> Products
        </a>
        <a href="{{ url_for('admin', tab='orders') }}" class="{{ 'active' if tab == 'orders' }}"> 
          <i class="fas fa-shopping-cart"></i> Orders
        </a>
        <a href="{{ url_for('admin', action='logout') }}" class="logout">
          <i class="fas fa-sign-out-alt"></i> Logout
        </a>
      </nav>
    </aside>

    <main class="main-content">
      {% if tab == 'dashboard' %}
        <h1>Dashboard Overview</h1>
        <div class="stats">
          <div class="stat-card">
            <h3>{{ products|length }}</h3>
            <p>Products</p>
          </div>
          <div class="stat-card">
            <h3>{{ orders|length }}</h3>
            <p>Orders</p>
          </div>
        </div>
        <h2>Recent Orders</h2>
        <div class="recent-list">
          {% for order in orders[:5] %}
          <div class="list-item">
            <strong>{{ order.customer_name }}</strong> â€¢ KES {{ "%.2f"|format(order.total) }}<br>
            <small>{{ order.phone }} â€¢ {{ order.country }}</small>
            {% if order.email %}<br><small>Email: {{ order.email }}</small>{% endif %}
          </div>
          {% endfor %}
        </div>

      {% elif tab == 'products' %}
        <div class="header-actions">
          <h1>{% if edit_product %}Edit Product{% else %}Manage Products{% endif %}</h1>
          {% if not edit_product %}
            <button onclick="document.getElementById('add-form').style.display='block'" class="btn-add">+ Add Product</button>
          {% endif %}
        </div>

        <!-- ADD/EDIT FORM -->
        <div id="add-form" class="form-section" {% if not edit_product %}style="display:none;"{% endif %}>
          <form method="POST" enctype="multipart/form-data">
            {% if edit_product %}
              <input type="hidden" name="product_id" value="{{ edit_product._id }}">
            {% endif %}
            <div class="form-group">
              <label>Product Name</label>
              <input type="text" name="name" value="{{ edit_product.name if edit_product else '' }}" required>
            </div>
            <div class="form-group">
              <label>Description</label>
              <textarea name="description" required>{{ edit_product.description if edit_product else '' }}</textarea>
            </div>
            <div class="form-group">
              <label>Category</label>
              <select name="category" id="category-select" required>
                <option value="perfume" {% if edit_product and edit_product.category == 'perfume' %}selected{% endif %}>Perfume</option>
                <option value="ebook" {% if edit_product and edit_product.category == 'ebook' %}selected{% endif %}>eBook</option>
              </select>
            </div>
            <div class="form-group">
              <label>Price (KES)</label>
              <input type="number" step="0.01" name="price" value="{{ edit_product.price if edit_product else '' }}" required>
            </div>
            <div class="form-group">
              <label id="stock-label">Stock</label>
              <input type="number" name="stock" 
                     value="{{ edit_product.stock if edit_product and edit_product.stock >= 0 else '10' }}"
                     {% if edit_product and edit_product.category == 'ebook' %}disabled{% endif %}
                     required>
              <small id="stock-note">eBooks have unlimited stock</small>
            </div>
            <div class="form-group">
              <label id="file-label">Product Image</label>
              {% if edit_product and edit_product.image_url %}
                <div class="current-file">
                  {% if edit_product.image_url.endswith(('.pdf', '.epub', '.mobi')) %}
                    <p>ðŸ“„ Current eBook: <strong>{{ edit_product.image_url.split('/')[-1] }}</strong></p>
                  {% else %}
                    <img src="{{ url_for('static', filename='uploads/' + edit_product.image_url) }}" 
                         alt="Current" style="max-height: 100px; border-radius: 4px;">
                  {% endif %}
                </div>
              {% endif %}
              <input type="file" name="image" id="file-input" accept="image/*,.pdf,.epub,.mobi">
              <small id="file-help">For eBooks: Upload PDF/EPUB. For Perfumes: Upload JPG/PNG.</small>
            </div>
            <button type="submit" class="btn-submit">
              {% if edit_product %}Update Product{% else %}Add Product{% endif %}
            </button>
            {% if edit_product %}
              <a href="{{ url_for('admin', tab='products') }}" class="btn-cancel">Cancel</a>
            {% else %}
              <button type="button" onclick="document.getElementById('add-form').style.display='none'" class="btn-cancel">Cancel</button>
            {% endif %}
          </form>
        </div>

        <!-- PRODUCT LIST -->
        {% if not edit_product %}
          <h2>All Products</h2>
          <div class="items-list">
            {% for p in products %}
            <div class="item-card">
              {% if p.image_url %}
                {% if p.image_url.endswith(('.pdf', '.epub', '.mobi')) %}
                  <div class="file-icon">ðŸ“„</div>
                {% else %}
                  <img src="{{ url_for('static', filename='uploads/' + p.image_url) }}" 
                       alt="{{ p.name }}" style="height: 60px; object-fit: cover; border-radius: 4px; margin-bottom: 0.5rem;">
                {% endif %}
              {% endif %}
              <div>
                <strong>{{ p.name }}</strong><br>
                <span class="category-badge {{ p.category }}">{{ p.category|title }}</span><br>
                KES {{ "%.2f"|format(p.price) }} â€¢ Stock: {{ p.stock if p.stock >= 0 else 'âˆž' }}
              </div>
              <div class="item-actions">
                <a href="{{ url_for('admin', tab='products', edit=p._id) }}" class="btn-edit">Edit</a>
                <a href="{{ url_for('admin', tab='products', action='delete', type='product', id=p._id) }}" 
                   class="btn-delete" onclick="return confirm('Delete {{ p.name }}?')">Delete</a>
              </div>
            </div>
            {% endfor %}
          </div>
        {% endif %}

      {% elif tab == 'orders' %}
        <h1>Order Management</h1>
        <div class="items-list">
          {% for o in orders %}
          <div class="item-card">
            <div>
              <strong>{{ o.customer_name }}</strong><br>
              <small>{{ o.phone }} â€¢ {{ o.country }}</small><br>
              <em>{{ o.address }}</em><br>
              Total: <strong>KES {{ "%.2f"|format(o.total) }}</strong>
              {% if o.email %}<br><small>Email: {{ o.email }}</small>{% endif %}
            </div>
            <div>
              Status: <strong>
                {% if o.status == 'delivered' %}
                  <span style="color: #27ae60;">âœ“ Delivered</span>
                {% else %}
                  {{ o.status|default('pending')|title }}
                {% endif %}
              </strong><br>
              <small>{{ o.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
              {% if o.status != 'delivered' %}
                <form method="POST" style="margin-top: 0.5rem;">
                  <input type="hidden" name="order_id" value="{{ o._id }}">
                  <button type="submit" class="btn-done">Mark as Done</button>
                </form>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      {% endif %}
    </main>
  </div>
  {% endif %}

  <script>
    // Dynamic form behavior
    function updateForm() {
      const category = document.getElementById('category-select')?.value;
      if (!category) return;
      
      const isEbook = category === 'ebook';
      document.getElementById('stock-label').textContent = isEbook ? 'Stock (ignored)' : 'Stock';
      document.getElementById('file-label').textContent = isEbook ? 'eBook File (PDF/EPUB)' : 'Product Image';
      
      const fileInput = document.getElementById('file-input');
      if (fileInput) {
        fileInput.accept = isEbook ? '.pdf,.epub,.mobi' : 'image/*';
      }
      
      const stockInput = document.querySelector('input[name="stock"]');
      const stockNote = document.getElementById('stock-note');
      if (stockInput) {
        stockInput.disabled = isEbook;
        stockNote.style.display = isEbook ? 'block' : 'none';
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      const categorySelect = document.getElementById('category-select');
      if (categorySelect) {
        categorySelect.addEventListener('change', updateForm);
        updateForm();
      }
    });
  </script>

  <style>
    .file-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f0f8ff;
      width: 60px;
      height: 60px;
      border-radius: 8px;
    }
    .category-badge {
      display: inline-block;
      padding: 0.1rem 0.5rem;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: 600;
      margin: 0.2rem 0;
    }
    .category-badge.perfume { background: #e1f0fa; color: #2980b9; }
    .category-badge.ebook { background: #e8f5e9; color: #27ae60; }
    #stock-note {
      display: none;
      font-size: 0.85rem;
      color: #7f8c8d;
      margin-top: 0.25rem;
    }
    .current-file {
      margin: 0.5rem 0;
      padding: 0.5rem;
      background: #f8f9fa;
      border-radius: 6px;
      font-size: 0.9rem;
    }
    .current-file strong {
      color: #2c3e50;
    }
  </style>
</body>
</html>